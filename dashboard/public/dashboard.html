<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strive Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: white;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h2 {
      margin-bottom: 20px;
    }
    .server {
      background: #2b2b2b;
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    a {
      color: #5865F2;
      text-decoration: none;
      font-weight: bold;
    }
    .error {
      color: #ff4d4d;
      text-align: center;
      padding: 20px;
    }
    .loading {
      text-align: center;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h2>Strive Dashboard</h2>
  <div id="content">
    <div class="loading">Loading your dashboard...</div>
  </div>

  <script>
    async function loadDashboard() {
      const content = document.getElementById('content');

      try {
        // Fetch user
        const userRes = await fetch('/api/user', { method: 'GET' });
        if (!userRes.ok) {
          if (userRes.status === 401) {
            throw new Error('Unauthorized');
          }
          throw new Error('Failed to load user');
        }
        const userData = await userRes.json();

        // Fetch servers
        const serversRes = await fetch('/api/servers', { method: 'GET' });
        if (!serversRes.ok) {
          throw new Error('Failed to load servers');
        }
        const serversData = await serversRes.json();

        // Build HTML
        let html = `<h3>Welcome, ${escapeHtml(userData.user.username)}!</h3>`;
        html += '<h4>Your Servers:</h4>';

        if (!serversData.servers || serversData.servers.length === 0) {
          html += '<p>No servers where you have admin permissions.</p>';
        } else {
          serversData.servers.forEach(s => {
            const name = escapeHtml(s.name);
            html += `
              <div class="server">
                <span>${name}</span>
                <a href="/setup.html?guild=${encodeURIComponent(s.id)}">Setup Tickets</a>
              </div>
            `;
          });
        }

        content.innerHTML = html;
      } catch (err) {
        console.error('Dashboard load error:', err);
        if (err.message === 'Unauthorized') {
          content.innerHTML = `
            <div class="error">
              <h3>üîí Session expired</h3>
              <p>You need to log in again.</p>
              <a href="/login?redirect=/dashboard">Re-login with Discord</a>
            </div>
          `;
          // Optional: auto-redirect after 3 seconds
          setTimeout(() => {
            window.location.href = '/login?redirect=/dashboard';
          }, 3000);
        } else {
          content.innerHTML = `
            <div class="error">
              <h3>‚ö†Ô∏è Failed to load dashboard</h3>
              <p>${escapeHtml(err.message)}</p>
              <a href="/">Go home</a>
            </div>
          `;
        }
      }
    }

    // Simple HTML escape to prevent XSS
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return String(unsafe);
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Start loading
    loadDashboard();
  </script>
</body>
</html>
